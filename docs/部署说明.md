# 部署说明

​	本文我们将详细介绍数据监管平台的部署搭建。这里我们同样采取的是从下至上的方式进行介绍，将从底层链的搭建开始，一层一层介绍，直到整个环境搭建完成。从底层链搭建开始介绍，这主要是为了保证安装部署体验的完整性。如果在现实场景中，底层链已经搭建好，并且上面已经有实际业务在跑，大家可以跳过相关步骤。

​	![[]](./images/install.png)



## 1. FISCO-BCOS搭建

### 1.1 参考文档

<https://fisco-bcos-documentation.readthedocs.io/zh_CN/latest/docs/manual/build_chain.html>

### 1.2 环境准备

- 建议使用CentOS 7或Ubuntu 16.04 64bit

- 开发部署工具` build_chain.sh`脚本依赖于`openssl, curl`，使用下面的指令安装。 若为CentOS，将下面命令中的`apt`替换为`yum`执行即可。macOS执行`brew install openssl curl`即可。

  ```
  sudo apt install -y openssl curl
  ```

- 创建操作目录

  ```
  cd ~ && mkdir -p fisco && cd fisco
  ```

- 下载`build_chain.sh`脚本

  ```
  curl -LO https://github.com/FISCO-BCOS/FISCO-BCOS/releases/download/v2.7.1/build_chain.sh && chmod u+x build_chain.sh
  ```

### 1.3 搭建联盟链

​	以存证链为例，搭建两个群组（区块链数字版权应用和贷款存证应用），每个群组三个节点（监管机构agencyA同时拥有两个群组的节点，所以一共五个节点）。

- 在fisco目录下执行下面的指令，生成配置文件`ipconf`

  ```
  # 127.0.0.1:1 表示127.0.0.1机器上1个节点
  # agency 机构名
  # 1,2 群组id
  cat  > ipconf << EOF
  127.0.0.1:1 agencyA 1,2
  127.0.0.1:1 agencyB 1
  127.0.0.1:1 agencyC 1
  127.0.0.1:1 agencyD 2
  127.0.0.1:1 agencyE 2
  EOF
  ```

- 生成节点目录，节点端口自增，请确保机器的`30300~30304，20200~20204，8545~8549`端口没有被占用

  ```
  bash build_chain.sh -f ipconf -p 30300,20200,8545 -v 2.5.0
  ```

- 启动所有节点

  ```
  bash nodes/127.0.0.1/start_all.sh
  ```

- 检查进程

  ```
  ps -ef | grep -v grep | grep fisco-bcos
  ```

- 日志

  执行下面指令，检查是否在共识

  ```
  tail -f nodes/127.0.0.1/node0/log/log*  | grep +++
  ```

  正常情况会不停输出`++++Generating seal`，表示共识正常

  ```
  info|2020-08-13 14:42:52.389343|[g:2][CONSENSUS][SEALER]++++++++++++++++ Generating seal on,blkNum=1,tx=0,nodeIdx=1,hash=0f69b346...
  info|2020-08-13 14:42:53.369051|[g:1][CONSENSUS][SEALER]++++++++++++++++ Generating seal on,blkNum=1,tx=0,nodeIdx=2,hash=4a3b23f1...
  info|2020-08-13 14:42:55.402984|[g:2][CONSENSUS][SEALER]++++++++++++++++ Generating seal on,blkNum=1,tx=0,nodeIdx=1,hash=c967ccf8...
  ```

  

## 2. WeBASE-Front搭建

​	WeBASE-Front为节点前置服务，数据监控平台通过节点前置服务拉取区块链相关数据。存证链中，监管机构agencyA拥有的节点在两个群组中，部署一个节点前置服务即可，连接其拥有的节点。

### 2.1 参考文档

<https://webasedoc.readthedocs.io/zh_CN/latest/docs/WeBASE-Install/developer.html>

### 2.2 环境准备

| 依赖软件 |                        支持版本                        |
| :------: | :----------------------------------------------------: |
|   Java   | JDK8或以上版本（[附录1.1](./附录.md#11-Java部署)） |

### 2.3 服务部署

- 下载安装包并解压

  ```
  wget https://osp-1257653870.cos.ap-guangzhou.myqcloud.com/WeBASE/releases/download/v1.4.2/webase-front.zip && unzip webase-front.zip && cd webase-front
  ```

- 拷贝证书文件

  将节点所在目录nodes/${ip}/sdk下的证书（ca.crt、node.crt、node.key）拷贝到conf下。如果区块链为国密链，则复制nodes/${ip}/sdk/gm下的证书（gmca.crt、gmsdk.crt、gmsdk.key、gmensdk.crt、gmensdk.key）。

  ```
  cp -r ~/fisco/nodes/127.0.0.1/sdk/* ./conf
  ```

- 配置修改

  默认连接本机channelPort为20200的节点。如果需要修改，则修改conf下application.yml文件的ip和channelPort。如果区块链为国密链，encryptType需设置为1。

  ```
  vi application.yml
  
  ...
  sdk:
    ...
    ip: 127.0.0.1						// 连接节点的监听ip
    channelPort: 20200				// 连接节点的链上链下端口
    encryptType: 0					// 0:ecdsa, 1:国密
  ...
  ```

- 服务启停

  ```
  启动： bash start.sh
  停止： bash stop.sh
  检查： bash status.sh 
  ```

- 访问

  ```
  http://{deployIP}:{frontPort}/WeBASE-Front
  示例：http://localhost:5002/WeBASE-Front
  ```

- 查看日志

  ````
  前置服务日志：tail -f log/WeBASE-Front.log
  web3连接日志：tail -f log/web3sdk.log
  ````

  

## 3. 数据监管平台搭建

### 3.1 环境准备

|         依赖软件          |                          支持版本                           |
| :-----------------------: | :---------------------------------------------------------: |
|           Java            |   JDK8或以上版本（[附录1.1](./附录.md#11-Java部署)）    |
|           MySQL           |   5.6或以上版本（[附录1.2](./附录.md#12-数据库部署)）   |
|       Elasticsearch       |   7.8.0（[附录1.3](./附录.md#13-Elasticsearch部署)）    |
| elasticsearch-analysis-ik |   7.8.0（[附录1.3](./附录.md#13-Elasticsearch部署)）    |
|           Nginx           | nginx1.6或以上版本（[附录1.4](./附录.md#14-nginx安装)） |

- 在服务搭建的过程中，如碰到问题，请查看[常见问题（附录2）](./附录.md#2-常见问题)

### 3.2 WeBASE-Data-Collect搭建

​	WeBASE-Data-Collect为监管数据导出和分析服务，自带配置页面，支持配置多个链，并通过添加区块链前置来获取区块链数据。同时可以配置应用相关信息，合约和用户信息。部署后具体使用请参考[使用手册](./使用手册.md)。

#### 3.2.1 上传安装包

将package目录下WeBASE-Data-Collect.zip上传并解压

```
unzip WeBASE-Data-Collect.zip && cd WeBASE-Data-Collect
```

#### 3.2.2 数据库初始化

（1）新建数据库

```
#登录MySQL:
mysql -u ${your_db_account} -p${your_db_password} 
例如：mysql -u root -p123456
#新建数据库：
CREATE DATABASE IF NOT EXISTS {your_db_name} DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
例如：CREATE DATABASE IF NOT EXISTS webasedata DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
```

（2）修改脚本配置

进入数据库脚本目录script

```shell
cd script
```

修改数据库连接信息：

```shell
修改数据库名称：sed -i "s/webasedata/${your_db_name}/g" webase.sh
修改数据库用户名：sed -i "s/defaultAccount/${your_db_account}/g" webase.sh
修改数据库密码：sed -i "s/defaultPassword/${your_db_password}/g" webase.sh
```

例如：将数据库用户名修改为root，则执行：

```shell
sed -i "s/defaultAccount/root/g" webase.sh
```

（3）运行数据库脚本

```shell
bash  webase.sh ${dbIP} ${dbPort}
例如：bash webase.sh 127.0.0.1 3306
```

#### 3.2.3 配置修改
（1）回到WeBASE-Data-Collect目录，修改配置文件applicationyml

```
vi conf/applicationyml
```

（2）主要修改数据库连接和es连接信息，完整配置项说明请查看 [配置项说明（附录3.1）](./附录.md#31-WeBASE-Data-Collect配置项)
```shell
...
server:
  port: 5009
  servlet:
    context-path: /WeBASE-Data-Collect

# database connection configuration
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3306/webasedata?serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull
    username: "defaultAccount"
    password: "defaultPassword"
  elasticsearch:
    rest:
      uris: 127.0.0.1:9200
      username: 
      password: 
...
```

#### 3.2.4 服务启停
```shell
启动：bash start.sh
停止：bash stop.sh
检查：bash status.sh
```
**备注**：服务进程起来后，需通过日志确认是否正常启动，出现以下内容表示正常；如果服务出现异常，确认修改配置后，重启。如果提示服务进程在运行，则先执行stop.sh，再执行start.sh。

```
...
	Application() - main run success...
```

#### 3.2.5 访问

配置页面访问：

```
http://{deployIP}:{deployPort}/WeBASE-Data-Collect
示例：http://localhost:5009/WeBASE-Data-Collect
```

- 部署服务器IP和服务端口需对应修改，网络策略需开通

#### 3.2.6 查看日志

```shell
全量日志：tail -f log/WeBASE-Data-Collect.log
错误日志：tail -f log/WeBASE-Data-Collect-error.log
```

### 3.3 WeBASE-Data-Fetcher搭建

​	WeBASE-Data-Fetcher为监管数据查询服务，向WeBASE-Data-Web服务提供数据查询接口。

#### 3.3.1 上传安装包

将package目录下WeBASE-Data-Fetcher.zip上传并解压

```
unzip WeBASE-Data-Fetcher.zip && cd WeBASE-Data-Fetcher
```

#### 3.3.2 配置修改

（1）修改配置文件applicationyml

```
vi conf/applicationyml
```

（2）主要修改数据库连接和es连接信息**（数据库连接和es连接信息和WeBASE-Data-Collect使用同一个）**，完整配置项说明请查看 [配置项说明（附录3.2）](./附录.md#32-WeBASE-Data-Fetcher配置项)

```shell
...
server:
  port: 5010
  servlet:
    context-path: /WeBASE-Data-Fetcher

# database connection configuration
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3306/webasedata?serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull
    username: "defaultAccount"
    password: "defaultPassword"
  elasticsearch:
    rest:
      uris: 127.0.0.1:9200
      username: 
      password: 
...
```

#### 3.3.3 服务启停

```shell
启动：bash start.sh
停止：bash stop.sh
检查：bash status.sh
```

**备注**：服务进程起来后，需通过日志确认是否正常启动，出现以下内容表示正常；如果服务出现异常，确认修改配置后，重启。如果提示服务进程在运行，则先执行stop.sh，再执行start.sh。

```
...
	Application() - main run success...
```

#### 3.3.4 访问

没有单独页面，可以通过swagger查看调用接口：

```
http://{deployIP}:{deployPort}/WeBASE-Data-Fetcher/swagger-ui.html
示例：http://localhost:5010/WeBASE-Data-Fetcher/swagger-ui.html
```

- 部署服务器IP和服务端口需对应修改，网络策略需开通

#### 3.3.5 查看日志

```shell
全量日志：tail -f log/WeBASE-Data-Fetcher.log
错误日志：tail -f log/WeBASE-Data-Fetcher-error.log
```

### 3.4 WeBASE-Data-Web搭建

​	WeBASE-Data-Web为数据监管平台，提供数据浏览页面。部署后具体使用请参考[使用手册](./使用手册.md)。

#### 3.4.1 上传安装包

将package目录下WeBASE-Data-Web.zip上传并解压

```
unzip WeBASE-Data-Web.zip && cd WeBASE-Data-Web
```

#### 3.4.2 配置修改

​	在docs目录下有配置文件nginx.conf，修改完后替换安装的nginx的配置文件nginx.conf（这里nginx安装配置文件在/usr/local/nginx/conf下面，如果这里没找到，可以到/etc下寻找，如有权限问题，请加上sudo）。

- 修改配置：

```
# 修改服务器ip，也可以使用域名
sed -i "s%127.0.0.1%${your_ip}%g" docs/nginx.conf

# 修改WeBASE-Data-Web服务端口（端口需要开通策略且不能被占用）
sed -i "s%5200%${your_port}%g" docs/nginx.conf

# 修改静态文件路径（文件需要有权限访问）
sed -i "s%/data/WeBASE-Data-Web/dist%${your_file_dir}%g" docs/nginx.conf

# WeBASE-Data-Fetcher服务ip和端口
sed -i "s%10.0.0.1:5010%${your_fetcher}%g" docs/nginx.conf
```

- 复制配置文件nginx.conf

```
cp -rf docs/nginx.conf /usr/local/nginx/conf
```

**备注：**  如果服务器已有nginx，可在原配置文件nginx.conf增加一个server：

```
    upstream data_server{
        server 10.0.0.1:5010; # WeBASE-Data-Fetcher服务ip和端口
    }
    server {
        listen       5200 default_server; # 前端端口（端口需要开通策略且不能被占用）
        server_name  127.0.0.1;           # 服务器ip，也可配置为域名
        location / {
                root   /data/WeBASE-Data-Web/dist;   # 前端文件路径(文件需要有权限访问)
                index  index.html index.htm;
                try_files $uri $uri/ /index.html =404;
        }

        include /etc/nginx/default.d/*.conf;

        location /mgr {
                    proxy_pass    http://data_server/;    		
                    proxy_set_header		Host			 $host;
                    proxy_set_header		X-Real-IP		 $remote_addr;
                    proxy_set_header		X-Forwarded-For	 $proxy_add_x_forwarded_for;
        }
    }
```

#### 3.4.3 启动nginx

启动命令：

```
/usr/local/nginx/sbin/nginx # nginx在/usr/local目录下
```

检查nginx是否启动：

```
ps -ef | grep nginx
```

#### 3.4.4 访问

```
http://{deployIP}:{webPort}
示例：http://127.0.0.1:5200
```

- 部署服务器IP和服务端口需对应修改，网络策略需开通

#### 3.4.5 查看日志

```shell
进程日志：tail -f logs/access.log
错误日志：tail -f logs/eror.log
```

